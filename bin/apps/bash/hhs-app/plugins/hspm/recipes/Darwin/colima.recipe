#!/usr/bin/env bash

function _about_() {
  echo "Container runtimes on macOS (and Linux) with minimal setup"
}

function _install_() {

  local packages

  packages=('colima' 'docker' 'docker-compose' 'docker-buildx' 'docker-credential-helper')

  # shellcheck disable=SC2154
  if ! command brew install "${packages[@]}" 1>/dev/null; then
    sed -i'' -e 's|"credsStore": ".*"|"credsStore": "osxkeychain"|g' ~/.docker/config.json
    __hhs_errcho "hspm.bash: unable to install colima"
    return 1
  fi

  [[ -d "${HOME}/.docker/cli-plugins" ]] || mkdir "-p ~/.docker/cli-plugins"
  \rm -f "${HOME}/.docker/cli-plugins/*"

  pushd ~/.docker/cli-plugins &>/dev/null || return 1
  ln -s "$(which docker-compose)" .
  ln -s "$(which docker-buildx)" .
  popd &>/dev/null || return 1

  return 0
}

function _uninstall_() {
  packman="${HHS_MY_OS_PACKMAN}"

  command "${packman}" uninstall "${packages[@]}" &&
    command "${packman}" deps "$@" |
    xargs "${packman}" remove --ignore-dependencies

  return $?
}
