#!/usr/bin/env bash

function _about_() {
  echo "An open source automation server which enables developers to reliably build, test, and deploy their software."
  return 0
}

function _depends_() {

  local tools

  tools=('apt-get' 'apt' 'yum' 'dnf')
  for pkg_man in "${tools[@]}"; do
    command -v "${pkg_man}" &>/dev/null && return 0
  done

  __hhs_errcho "hspm.bash: no suitable tool found to install default software on this machine. Tried: ${tools[*]}"

  return 1
}

function _install_() {

  local jenkins_dl_url keyring_dir jenkins_key arch ret_val=1 source_dir

  arch="$(dpkg --print-architecture)"
  keyring_dir='/usr/share/keyrings'
  source_dir='/etc/apt/sources.list.d'
  jenkins_key="${keyring_dir}/jenkins.asc"
  jenkins_dl_url='https://pkg.jenkins.io/debian-stable'

  command -v sudo &>/dev/null && SUDO=sudo

  # 1. Add Jenkins’s official key:
  echo "1. Add Jenkins’s official key ..."
  if ${SUDO} install -m 0755 -d "${keyring_dir}"; then
    if curl -fsSL "${jenkins_dl_url}/jenkins.io-2023.key" | ${SUDO} tee "${jenkins_key}" >/dev/null; then
      if ${SUDO} chmod a+r "${jenkins_key}"; then
        ret_val=0
      fi
    fi
  fi

  if [[ $ret_val -ne 0 ]]; then
    __hhs_errcho "hspm.bash: unable to set official Jenkins key"
    return 1
  fi

  # 2. Set up jenkins repository:
  echo "2. Set up jenkins repository ..."
  if ! echo "deb [arch=${arch} signed-by=${jenkins_key}] ${jenkins_dl_url} binary/" \
    >"${source_dir}/jenkins.list"; then
    __hhs_errcho "hspm.bash: unable to set official Jenkins repository"
    return 1
  fi

  # 3. Update to apply the new repository:
  echo "3. Update to apply the new repository ..."
  if ${SUDO} "${HHS_MY_OS_PACKMAN}" update; then
    # 4. Install jenkins
    if ${SUDO} "${HHS_MY_OS_PACKMAN}" -y install jenkins; then
      return 0
    fi
  fi

  return 1
}

function _uninstall_() {

  command -v sudo &>/dev/null && SUDO=sudo

  if command -v "${HHS_MY_OS_PACKMAN}" &>/dev/null && ${SUDO} "${HHS_MY_OS_PACKMAN}" -y remove jenkins; then
    return $?
  fi

  return 1
}
