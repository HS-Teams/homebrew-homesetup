/*
    Gradle Bash extension
    Project: HomeSetup
    Created: 5th March, 2022
*/

/* Helper Functions -------------------------------------------------------- */

String dirName(File file) {
  file.getParentFile().getPath()
}

/***** Verification Group */

/* Run all Bats tests */
task bats(type: Task) {
  group = 'Verification'
  description = "Run all Bats test"
  doLast {
    println "Performing bats tests from $rootDir/tests"
    fileTree("$rootDir/tests").matching {
      include "**/*.bats"
    }.each { File file ->
      if (verbose) {
          println ""
          println "Executing bats tests from -> $file.name"
          println ""
        }
        exec {
          workingDir = dirName(file)
          commandLine 'bats', '--tap', file.path
        }
      }
  }
}

/* Publish a new HomeSetup version */
task publish(type: Task) {
  group = 'Publish'
  description = "Publish a new HomeSetup version"
  dependsOn changeVersion
  dependsOn updateVersion
  doLast {
    def out = new ByteArrayOutputStream()
    def version = new File("$versionFile").text
    println "Publishing version $version of HomeSetup..."
    exec {
      commandLine 'git', 'log', '--pretty=format:%s', 'origin/master..HEAD'
      standardOutput = out
    }
    println(out.toString().trim())
    /*
    exec {
      commandLine 'git', 'add', '-A', ':/'
    }
    exec {
      commandLine 'git', 'commit', '-m', '++version'
    }
    exec {
      commandLine 'git', 'push', 'origin', 'HEAD'
    }
    */
  }
}

/* end */
